\chapter{Määritelmät\label{methods}}

\section{Verkko}
Tutkielmassa oletetaan, että käsiteltyjä protokollia suoritetaan internetin välityksellä asynkronisesti. Osallistujat eivät välttämättä jaa yhteistä kelloa ja lähetettyjen viestien välillä voi olla vaihteleva viive. Käytettäessä lohkoketjua osallistujien transaktioiden lähettäminen tapahtuu asynkronisesti, mutta osallistujat jakavat lohkoketjun muodostaman ajan. Oletetaan, että lohkoketju tuottaa uusia lohkoja keskimäärin vakio ajassa. Järjestelmän aikayksikkönä voidaan käyttää lohkon numeroa. Esimerkiksi Ethereum muodostaa uuden lohkon noin 15 sekunnin välein.

\section{Hajautusfunktio}

\section{Julkisen avaimen salaus}

\section{Vahvistettava Satunnaisfunktio (Verifiable Random Function, VRF)}

\section{Vahvistettava Viivefunktio (Verifiable Delay Function, VDF)}

\section{(t, n)-Salaisuuksien jakaminen ((t,n)-Secret Sharing, SS)}

\section{Homomorfinen salaus (Homomorphic Encryption, HE)}

\section{Osallistujat}

Protokollaan oletetaan osallistuvan $N$ osallistujaa, $N > 1$.

Haitallisia osallistujia kutsutaan myös hyökkääjiksi. Hyökkääjien laskentateho on korkeintaan polynomisesti suurempaa kuin rehellisten osallistujien. Hyökkääjä ei siis kykene vahvoiksi oletettuja kryptograafisia työkaluja, kuten esimerkiksi julkisen avaimen salausta.

Järjestelmässä jokaisella osallistujalla on käytössään julkisen avaimen salauksen avainpari, jonka mahdollistamilla allekirjoituksilla osallistuja tunnistaa itsensä. Hyökkääjä ei voi siten esittää toista osallistujaa. Avainparia, jolla hallinnoidaan muille osallistujille näkyvää julkista avainta voidaan kutsua tutkielmassa lohkoketjuympäristössä myös nimellä \textit{tili} tai \textit{osoite}. On huomioitavaa, että yksittäinen osallistuja voi generoida itselleen haluamansa määrän avainpareja ja näyttäytyä täten muille osallistujille monina osallistujina.

\section{Lohkoketju}

Lohkoketju on hajautettu, lupavapaa ja muuttumaton tilikirja. Perinteisesti tilikirjalla tarkoitetaan tilien kokoelmaa, johon on merkitty kaikki tilien olemassaolon aikana tapahtuneet transaktiot. Uutta tietoa on mahdollista lisätä vain tilikirjan loppuun lisäämällä uusia transaktioita. Lohkoketjun tapauksessa tilikirja tarkoittaa tietokantaa, johon tallennetaan tilien transaktioita ja uutta tietoa voi lisätä tietokantaan vain luomalla uusia transaktioita, jotka lisätään tietokantaan lohkossa. Tiivistäen lohko koostuu transaktioista, sekä edellisen lohkon hajautusarvosta. Edellisen lohkon hajautusarvo liittää uuteen lohkoon aikeisemmat transaktiot, muodostaen lohkoketjun. Tilejä lohkoketjussa hallinnoidaan julkisen avaimen salauksella. Salaisella avaimella allekirjoitetaan uusia transaktioita, jolla hallinnoidaan tilinä toimivaa julkisesta avaimesta johdettua osoitetta. Uusi transaktio julkaistaan kaikille osallistujille odottamaan, että tietokannan päivittämisestä vastaavat konsensusmekanismia suorittavat osallistujat lisäävät transaktion lohkoketjuun.

Lohkoketju on lupavapaa, mikä tarkoittaa sitä, että kuka tahansa voi osallistua tietokannan päivittämiseen lähettämällä uusia transaktioita, sekä lisäämällä transaktioita lohkoissa tietokantaan suorittamalla ketjun konsensusalgoritmia. Osallistujan tunnisteena toimii vain tämän salausavaimet. Lupavapauden johdosta järjestelmään voi osallistua myös haitallisia toimijoita, jotka haluavat esimerkiksi lähettää itseään hyödyntäviä transaktioita. Järjestelmän ollessa hajautettu, jotkut osallistujat voivat myös kohdata teknisiä ongelmia ja lopettaa osallistumisen, tai jopa alkaa lähettämään virheellisiä transaktioita haluamattaan. Osallistujilla pitää olla mekanismi jolla saavutetaan konsensus siitä mikä on tietokannan nykyinen validi tila kuvaillussa lupavapaassa ympäristössä. Lohkoketjun osallistujat suorittavat konsensusalgoritmia tietokannan nykyisen validin tilan selvittämiseksi. 

Huomioidaan kaksi merkittävintä konsensusmekanismia. Työtodistus(Proof of Work, PoW)-konsensusmekanismia, käyttää kirjoitushetkellä esimerkiksi Bitcoin, sekä Ethereum lohkoketjut. PoW-konsensusta kutsutaan myös Nakamoto-konsensukseksi, jonka tarkempi kuvaus löytyy Bitcoin-whitepaperista \cite{Nakamoto_bitcoin}. Uudempi ja yhä yleistyvä mekanismi on  osakkuustodistus(Proof of Stake, PoS). 

\subsection{PoW}
PoW-konsensuksessa uusien transaktioiden lohko liitetään lohkoketjuun pääpiirteittäin seuraavan protokollan mukaisesti: Jokainen konsensukseen osallistuja, joita kutsutaan kaivajiksi (Miner) kilpailee uuden lohkon lisäämisestä. Kaivaja valitsee uusista transaktioista joukon uutta lohkoa varten ja tarkistaa transaktioiden oikeellisuuden. Transaktiot, edellisen lohkon hajautusarvo, aikaleima sekä osallistujan valitsema satunnainen arvo (Nonce) syötetään hajautusfunktiolle (Esim. Bitcoinin tapauksessa SHA256). Aikaisempien lohkojen perusteella on sovittu tämänhetkistä vaikeutta kuvaava luku $v$. Jos saadun hajautusarvon alussa on peräkkäin vähintään $v$ 0-merkkiä on lohko hyväksyttävä. Tällöin kaivaja julkaisee uuden lohkon verkolle. Lohkon kanssa lähetetään metadataa, kuten esimerkiksi löydetty nonce, edellisen lohkon hajautusarvo sekä aikaleima. Muut kaivajat voivat vielä vahvistaa lohkon oikeellisuuden suorittamalla yllä mainitun transaktioiden validoinnin ja hajautusarvon laskemisen uudestaan ja varmistamalla, että saatu hajautusarvo on löytäjän ilmoittama. Kun uusi lohko on validoitu, aloittavat kaivajat prosessin alusta edellisenä lohkona toimien nyt löydetty validoitu lohko. Kaivajat yrittävät aina lisätä uutta lohkoa pisimmän validin ketjun jatkeeksi. Löytäjä saa palkkiona uuden lohkon luomisesta vastaluotua valuuttaa, kuten myös transaktiokuluja. Transaktiokulu on transaktion lähettäjän määräämä arvo, joka lisätään lähetettävän arvon päälle, joten kaivajat valitsevat lohkoon transaktioita joissa on suurimmat transaktiokulut.

Jos hajautusarvo ei alakaan halutulla määrällä nollia, kaivaja vaihtaa nonce-arvoa ja laskee hajautusarvon uudestaan. Sopivan hajautusarvon löytämiseen ei ole hajautusfunktion alkukuva resistenssin (Preimage resistance) myötä muuta keinoa kuin yrittää satunnaisia nonce-arvoja. Arvoa $v$ muuttamalla voidaan vaikuttaa siihen kuinka kauan sopivan nonce-arvon löytämisessä kestää keskimäärin tietyllä laskentateholla. Nonce-arvon esittäminen onkin todiste, että uuden lohkon lisäämisen eteen on tehty työtä. Protokolla olettaa, että lohkojen luomiseen kohdistuvasta laskentatehosta yli $50\%$ on rehellisten kaivajien hallussa. Lohkoketjussa aikaisemmin olevien lohkojen transaktioiden muuttaminen vaatisi, että laskentatyö tehdään uudestaan muutetun sekä kaikkien sitä seuraavien lohkojen kohdalla.

Tutkielman kannalta kiinnostavaa PoW-konsensusmekanismissa on se, että nonce-arvo, kuten siitä johdettu lohkon hajautusarvo, ei ole kenenkään ennustettavissa. PoW-lohkoketjujen lohkojen hajautusarvoa onkin mahdollista käyttää satunnaisuuden lähteenä. Hajautusarvon käyttöä satunnaisuuden lähteenä ja siihen liittyviä ongelmia käsitellään luvussa kolme.

\subsection{PoS}

PoS konsensusmekanismissa lohkoja tuottaa validaattoreiksi kutsuttu joukko osallistujia. Uuden lohkon tuottaja valitaan validaattoreiden joukosta satunnaisesti ja muut validaattorit vahvistavat luodun lohkon. Paino, joka määrää validaattorin todennäköisyyden tulla valituksi lohkon tuottajaksi ja tärkeyden vahvistettaessa uusia lohkoja määräytyy validaattorin tilin saldon myötä. Osallistuja joka ei ole validaattori voi delegoida oman saldonsa validaattorille palkintoa vastaan. Koska lohkoketjun valuutalla on arvoa, on mekanismissa hyökkääjien omattava mittava määrä taloudellista arvoa, jotta he voivat luoda haluamiaan lohkoja. Onnistunut hyökkäys myös alentaisi valuutan arvoa, haitaten hyökkääjää, joka todennäköisesti hyökkää nimenomaan valuutan arvon takia.

PoS-lohkoketjussa validaattoreiden tulee saavuttaa konsensus uuden lohkon oikeellisuudesta ja ketjussa on usein käytössä bysanttilaisia ongelmia sietävä konsensusmekanismi. Tällöin haitallisia osallistujia voi olla maksimissaan $t$ osallistujista, kun osallistujia on oltava vähintään $3t + 1$ \cite{10.1145/322186.322188}. Tämä alaraja pätee kuitenkin synkronisessa verkossa. Asynkronisessa verkossa konsensuksen taattu saavuttaminen deterministisellä konsensusprotokollalla on mahdotonta, jos edes yksi osallistuja toimii virheellisesti \cite{fischer_impossibility_1985}. Asynkroniseen ympäristöön on kehitetty epädeterministisiä, satunnaisuutta hyödyntäviä protokollia, joilla konsensuksen saavuttaminen on mahdollista. Näistä ensimmäisiä oli esimerkiksi M. Rabin esittämä protokolla \cite{10.1109/SFCS.1983.48}. Lohkoketjuesimerkkinä voi tutustua esimerkiksi Algorand ketjun konsensukseen \cite{gilad_algorand_2017}. PoS-lohkoketjuilla on siis tarve hajautetulle satunnaisuudelle verrattaen PoW-ketjuihin, jotka tuottavat satunnaisuutta.

\section{Lohkoketjusovellus}

Lohkoketjun tietokannan voi nähdä myös tilakoneena. Jokainen transaktio edistää tilakonetta edellisten lohkojen määrittämän tietokannan tilan pohjalta. Tietokantaan voidaan pelkkien tilien saldojen sijaan tallentaa kokonaisia ohjelmia. Näin tietokanta toimii Turing-täydellisenä laskenta-alustana ja lohkoketju muodostaa virtuaalikoneen, jolla kuka tahansa voi suorittaa mitä tahansa muuttumatonta laskentaa lupavapaasti.

Tämän idean toteutti ensimmäisenä lohkoketju Ethereum \cite{buterin_ethereum_2014}. Ethereum-lohkoketjuun tallennettuja ja suoritettavia ohjelmia kutsutaan älysopimuksiksi (Smart Contract). Älysopimuksella on osoite ja rajapintoja joita osallistujat kutsuvat transaktiossa edistääkseen älysopimuksen laskentaa. Transaktion lähettäjä maksaa laskennan edistämisestä transaktiokulun riippuen laskennan määrästä. Yhden transaktion aikana suoritettavalle laskennan määrälle on myös yläraja. Kirjoittamishetkellä Ethereum-ketjussa esimerkiksi sopimuksena määritellyn valuutan, ERC-20 tokenin, siirtäminen osoitteesta toiseen vaati kuluina noin 5.28\$ edestä Ethereum-valuuttaa \cite{etherscanio_ethereum_nodate}. Älysopimusten kanssa vuorovaikuttaminen on siis osallistujille taloudellisesti kallista, varsinkin jos sopimus on laskennallisesti vaativa. Satunnaisuutta generoivan protokollaan, joka suorittaa laskentaa lohkoketjussa, kohdistuu siis vaatimus mahdollisimman pienestä kommunikointikompleksisuudesta, sillä osallistujien kulut kasvavat muuten liian suuriksi protokollan suorittamiseen. On myös hyvä mainita, että älysopimuksia tukevissa lohkoketjuissa on viime vuosina tapahtunut merkittävää kehitystä ja jo nyt toiset lohkoketjut mahdollistavat Ethereum-ketjua moninkertaisesti pienemmät kulut. Älysopimuslaskennan suuren taloudellisen kustannuksen ongelma ei ole kuitenkaan täysin poistunut. 

On myös hyvä huomioida, että vaikka lohkoketju onkin lupavapaa, älysopimuksessa voi olla millaista logiikkaa tahansa ja siten suoritusoikeus voidaan rajata vain tietyille osoitteille. Satunnaisuuden generoimisen protokollassa on siis esimerkiksi mahdollista lukita osallistujat protokollan suorittamisen ajaksi jättäen suorittamiseen liittymisen ennen sen alkua lupavapaaksi.

Lohkoketjusovelluksella tarkoitetaan sovellusta, jonka ydinlogiikan suoritus tapahtuu lohkoketjun solmuissa. Osallistujat voivat suorittaa ohjelman vaatimaa laskentaa lohkoketjussa (On-chain) lähettämällä transaktoita, tai lohkoketjun ulkopuolella (Off-chain) omalla laitteellaan. Off-chain laskenta on osallistujalle transaktiokulujen takia moninkertaisesti halvempaa kuin on-chain laskenta. Osallistujien välinen viestintä tapahtuu lohkoketjun kautta, osallistujat eivät siis lähetä suoraan toisilleen viestejä.

\section{Satunnaisuus}

Protokollan generoimiin satunnaislukuihin kohdistetaan seuraavat vaatimukset joihin peilaten protokollaa analysoidaan:
\begin{itemize}
    \item[--] 1: Protokollan generoimat satunnaisluvut noudattavat satunnaisjakaumaa
    \item[--] 2: Protokollan generoimia satunnaislukuja ei voi ennustaa
    \item[--] 3: On julkisesti todennettavissa, että protokollan generoimat satunnaisluvut on generoitu protokollaa noudattaen.
    \item[--] 4: Generoitava satunnaisluku ei ole kenenkään manipuloitavissa
\end{itemize}\textbf{}

Tutkielmassa läpikäytävien protokollien pääpaino on vaatimuksissa 2, 3 ja 4 protokollien lupavapauden myötä. Lupavapaus johtaa siihen, että osallistujat eivät voi luottaa toisten osallistujien toimivan aina protokollan mukaisesti. Tämän vuoksi vaikka protokollan tuottamat satunnaisluvut ideaalitilanteessa noudattaisivatkin satunnaisjakaumaa, on osallistujan hyvä vaatia, että kukaan, osallistuja tai ulkopuolinen, ei kykene ennustamaan lukuja tai vaikuttamaan niihin. Julkisella todennettavuudella varmistetaan, että 
tuotetun luvun käyttäjä voi varmistua siitä, että luku on tuotettu nimenomaisella protokollalla. Tämä on erityisen tärkeää kun protokolla toimii majakkana. Muuten hyökkääjä voi esimerkiksi esittää majakkaa, mikä ei vaadi osallistumista itse generoimiseen. Tutkielmassa oletetaan, että jokaisella osallistujalla on käytössään luotettava satunnaisuuden lähde, jota rehellinen osallistuja käyttää jos protokolla vaatii osallistujalta satunnaisen syötteen. Hyökkääjälle tämä yksittäisen osallistujan satunnaisuuden lähde näyttäytyy täysin satunnaisena.

Vaatimusten lisäksi seuraavilla protokollan ominaisuuksilla on merkitystä protokollan käytettävyyden kannalta:

\begin{itemize}
    \item[--] 5: Mikä määrä $t$ protokollan osallistujista $N > N - t$ voi olla haitallisia, niin että protokolla kuitenkin tuottaa vaatimusten 1, 2, 3 ja 4 mukaisen luvun.
    \item[--] 6: Mikä on protokollan suorittamisen aikavaatimus suhteessa osallistujien määrään?
    \item[--] 7: Mikä on protokollan suorittamisen absoluuttinen aikavaatimus?
    \item[--] 8: Mikä on yksittäisen osallistujan kommunikointikompleksisuus?
\end{itemize}